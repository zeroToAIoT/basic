<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFarm Monitoring</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        h1 { color: #2c3e50; }
        .sensor-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
        .sensor-box { padding: 20px; border-radius: 10px; width: 220px; background: #ecf0f1; }
        #status { margin-top: 10px; font-weight: bold; }
        #image-gallery { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:20px; }
        #image-gallery img { max-width:180px; border:2px solid #ccc; border-radius:8px; }
    </style>
    <script>
        let piIP = '192.168.137.162'; // 기본값

        async function getConfig() {
            try {
                const response = await fetch(`http://${piIP}:5000/config`);
                const data = await response.json();
                if (data.pi_ip) {
                    piIP = data.pi_ip;
                }
            } catch (error) {
                console.log('[Config] fetch failed, using default IP');
            }
        }

        async function fetchSensorData() {
            try {
                const response = await fetch(`http://${piIP}:5000/sensor_data`);
                const data = await response.json();

                if (response.ok && data.sensor_data && data.sensor_data.length > 0) {
                    const latest = data.sensor_data[0];
                    document.getElementById("temp").innerText = `Temperature : ${latest.temperature}°C`;
                    document.getElementById("hum").innerText = `Humidity : ${latest.humidity}%`;
                    document.getElementById("moist").innerText = `Moisture : ${latest.moisture}%`;
                    document.getElementById("water").innerText = `Water Level : ${latest.water_level}%`;
                    document.getElementById("growth_db").innerText = `Growth Stage(DB) : ${latest.growth_level}`;
                    document.getElementById("conf_db").innerText = `Confidence(DB) : ${(latest.confidence*100).toFixed(1)}%`;
                    document.getElementById("status").innerText = "Sensor Data Loaded";
                } else {
                    document.getElementById("status").innerText = "No Sensor Data";
                }
            } catch (error) {
                document.getElementById("status").innerText = "Error fetching sensor data!";
            }
        }

        async function fetchGrowthStage() {
            try {
                const response = await fetch(`http://${piIP}:5000/growth_stage`);
                const data = await response.json();

                if (response.ok && data.growth_stage) {
                    document.getElementById("growth_ai").innerText = `Growth Stage(AI) : ${data.growth_stage}`;
                    if (data.confidence !== undefined) {
                        document.getElementById("conf_ai").innerText = `Confidence(AI) : ${(data.confidence*100).toFixed(1)}%`;
                    }
                } else if (data.error) {
                    document.getElementById("growth_ai").innerText = `Growth Stage(AI) : ${data.error}`;
                    document.getElementById("conf_ai").innerText = "Confidence(AI) : -";
                } else {
                    document.getElementById("growth_ai").innerText = "Growth Stage(AI) : Unknown";
                    document.getElementById("conf_ai").innerText = "Confidence(AI) : -";
                }
            } catch (error) {
                document.getElementById("growth_ai").innerText = "Growth Stage(AI) : Error!";
                document.getElementById("conf_ai").innerText = "Confidence(AI) : Error!";
            }
        }

        async function fetchRecentImages() {
            try {
                const response = await fetch(`http://${piIP}:5000/latest_images`);
                const data = await response.json();

                const gallery = document.getElementById("image-gallery");
                gallery.innerHTML = ""; // 초기화

                if (response.ok && data.images && data.images.length > 0) {
                    data.images.forEach(imgFile => {
                        const img = document.createElement("img");
                        img.src = `http://${piIP}:5000/image/${imgFile}?t=${new Date().getTime()}`;
                        gallery.appendChild(img);
                    });
                } else {
                    gallery.innerText = "No images available for the last 7 days.";
                }
            } catch (error) {
                document.getElementById("image-gallery").innerText = "Error loading images!";
            }
        }

        async function updateAll() {
            await getConfig(); // 먼저 설정 가져오기
            fetchSensorData();
            fetchGrowthStage();
            fetchRecentImages();
        }

        window.onload = updateAll;
        setInterval(updateAll, 5000);
    </script>
</head>
<body>
    <h1>Smart Farm Monitoring</h1>
    <p id="status">Loading Data...</p>
    <div class="sensor-container">
        <div class="sensor-box" id="temp">Temperature : -</div>
        <div class="sensor-box" id="hum">Humidity : -</div>
        <div class="sensor-box" id="moist">Moisture : -</div>
        <div class="sensor-box" id="water">Water Level : -</div>
        <div class="sensor-box" id="growth_db">Growth Stage(DB) : -</div>
        <div class="sensor-box" id="conf_db">Confidence(DB) : -</div>
        <div class="sensor-box" id="growth_ai">Growth Stage(AI) : -</div>
        <div class="sensor-box" id="conf_ai">Confidence(AI) : -</div>
    </div>

    <h2>Recent Images</h2>
    <div id="image-gallery">Loading images...</div>
</body>
</html>